<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rink Buddy</title>

<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">

<style>
  :root{
    --btn-start:#0022ff;
    --btn-end:#080D85;
    --text:#ffffff;
    --shadow: rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  /* Lock the viewport & prevent any scroll */
  html, body{
    height:100%;
    min-height:100svh;
    overflow:hidden;
  }

  body{
    margin:0;
    color:var(--text);
    background:#000 url("TitleBackground.png") center/cover no-repeat fixed;
    display:grid;
    place-items:center;               /* dead-center the card */
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    padding:
      calc(env(safe-area-inset-top,0) + 0px)
      calc(env(safe-area-inset-right,0) + 0px)
      calc(env(safe-area-inset-bottom,0) + 0px)
      calc(env(safe-area-inset-left,0) + 0px);
  }

  /* Fixed Logout button (hidden until signed in) */
  #logoutBtn{
    display:none; /* shown via JS -> inline-block */
    position:fixed;
    top:calc(12px + env(safe-area-inset-top,0));
    right:calc(12px + env(safe-area-inset-right,0));
    z-index:1000;
    border:0; border-radius:12px;
    padding:10px 14px;
    font-weight:800;
    background:rgba(0,0,0,.68);
    color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.4);
    cursor:pointer;
    backdrop-filter:saturate(1.2) blur(4px);
    transition:transform .07s ease, filter .2s ease;
  }
  #logoutBtn:hover{ transform:translateY(-1px); filter:brightness(1.07); }

  .scrim{
    position:fixed; inset:0;
    background:linear-gradient(to bottom, rgba(0,0,32,.20), rgba(0,0,0,.55));
    pointer-events:none;
  }

  .card{
    width:min(920px, 94svw);
    max-height:calc(100svh - 40px);    /* ensure no overflow */
    padding:clamp(12px, 2.5svh, 24px);
    text-align:center;
    backdrop-filter: blur(3px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:clamp(8px, 2svh, 16px);
  }

  .logo{
    width:clamp(200px, 60svw, 540px);
    height:auto;
    filter: drop-shadow(0 10px 24px var(--shadow));
  }

  /* Stacked buttons, perfectly centered */
  .buttons{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:clamp(12px, 2.2svh, 18px);
    width:min(560px, 90svw);
    margin:0;                          /* remove offset */
  }

  .rb-btn{
    display:block;
    width:100%;
    border:0; border-radius:18px;
    padding:18px 20px;
    text-decoration:none; color:var(--text);
    background:linear-gradient(180deg, var(--btn-start), var(--btn-end));
    box-shadow:0 10px 26px var(--shadow), inset 0 0 18px rgba(255,255,255,.10);
    transition: transform .07s ease, filter .2s ease, box-shadow .2s ease;
  }
  .rb-btn:hover{ transform: translateY(-1px); filter:brightness(1.05) }
  .rb-btn:active{ transform: translateY(0); filter:brightness(.97) }

  .rb-btn span{
    display:block;
    font-family:"Russo One", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    font-size: clamp(20px, 4.2vw, 28px);
    letter-spacing:.3px;
    text-shadow: 0 2px 12px rgba(0,0,0,.35);
  }

  #gsi{ display:flex; justify-content:center; margin-top:10px; }
  .pending{ font-weight:700; text-shadow:0 2px 10px var(--shadow); }
</style>
</head>
<body>
  <!-- Fixed Logout -->
  <button id="logoutBtn" title="Log out">Logout</button>

  <div class="scrim" aria-hidden="true"></div>

  <main class="card" role="main">
    <img class="logo" src="RinkBuddy.png" alt="Rink Buddy logo">

    <!-- Signed-out -->
    <div id="signedOut" style="display:none;">
      <div id="gsi"></div>
    </div>

    <!-- Subscription active -->
    <div id="menu" class="buttons" style="display:none;">
      <a class="rb-btn" href="CheckVariance.html"><span>NEW RINK CHECK</span></a>
      <a class="rb-btn" href="ViewVariances.html"><span>VIEW RINK CHECKS</span></a>
      <a class="rb-btn" href="templates.html"><span>RINK TEMPLATES</span></a>
      <a class="rb-btn" href="Settings.html"><span>SETTINGS</span></a>
    </div>

    <!-- Subscription inactive -->
    <div id="pending" class="pending" style="display:none;">
      Account pending activation.
    </div>
  </main>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithCredential, setPersistence, browserLocalPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
      authDomain: "rink-buddy-6f6ed.firebaseapp.com",
      projectId: "rink-buddy-6f6ed",
      storageBucket: "rink-buddy-6f6ed.appspot.com",
      messagingSenderId: "1096930052063",
      appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
      measurementId: "G-7HPRJ6T9LD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    await setPersistence(auth, browserLocalPersistence);

    const $ = (sel) => document.querySelector(sel);
    const signedOutEl = $("#signedOut");
    const gsiEl       = $("#gsi");
    const menuEl      = $("#menu");
    const pendingEl   = $("#pending");
    const logoutBtn   = $("#logoutBtn");

    function showSignedOut(){
      signedOutEl.style.display = "";
      menuEl.style.display = "none";
      pendingEl.style.display = "none";
      logoutBtn.style.display = "none";
      renderGoogleButton();
    }
    function showMenu(){
      signedOutEl.style.display = "none";
      pendingEl.style.display = "none";
      menuEl.style.display = "";
      logoutBtn.style.display = "inline-block";
    }
    function showPending(){
      signedOutEl.style.display = "none";
      menuEl.style.display = "none";
      pendingEl.style.display = "";
      logoutBtn.style.display = "inline-block";
    }

    let gsiInitialized = false;
    function renderGoogleButton(){
      if (gsiInitialized) return;
      const clientId = "1096930052063-f8mruob20i6k7s2e1tiem96ic1ek4h4s.apps.googleusercontent.com";
      if (!window.google || !google.accounts?.id){
        setTimeout(renderGoogleButton, 50);
        return;
      }
      google.accounts.id.initialize({
        client_id: clientId,
        callback: async (response) => {
          try{
            const idToken = response.credential;
            const cred = GoogleAuthProvider.credential(idToken);
            await signInWithCredential(auth, cred);
          }catch(err){
            console.error("Sign-in error:", err);
            alert("Google sign-in failed. Please try again.");
          }
        },
        auto_select:false, cancel_on_tap_outside:true
      });
      google.accounts.id.renderButton(gsiEl, {
        type:"standard", theme:"filled_blue", size:"large",
        text:"signin_with", shape:"rectangular", logo_alignment:"left", width:320
      });
      gsiInitialized = true;
      signedOutEl.style.display = "";
    }

    async function ensureUserDocAndSubscription(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const base = {
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        lastLoginAt: serverTimestamp()
      };
      if (!snap.exists()) {
        await setDoc(ref, { ...base, createdAt: serverTimestamp(), SubscriptionActive:false }, { merge:true });
        return false;
      } else {
        await setDoc(ref, base, { merge:true });
        const data = snap.data();
        if (typeof data.SubscriptionActive === "undefined") {
          await setDoc(ref, { SubscriptionActive:false }, { merge:true });
          return false;
        }
        return !!data.SubscriptionActive;
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user){ showSignedOut(); return; }
      try{
        const active = await ensureUserDocAndSubscription(user);
        if (active) showMenu(); else showPending();
      }catch(err){
        console.error("Subscription check failed:", err);
        showPending();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try{
        const u = auth.currentUser;
        if (u && window.google?.accounts?.id?.revoke) {
          window.google.accounts.id.revoke(u.email, () => {});
        }
        await signOut(auth);
        window.google?.accounts?.id?.disableAutoSelect?.();
        showSignedOut();
      }catch(err){
        console.error("Sign-out error:", err);
        showSignedOut();
      }
    });

    window.rbSignOut = async () => logoutBtn.click();
  </script>
</body>
</html>
