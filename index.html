<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rink Buddy</title>

<style>
  :root{
    --btn-start:#3f3d73;
    --btn-end:#5a58a8;
    --text:#ffffff;
    --shadow: rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    background:#000 url("TitleBackground.png") center/cover no-repeat fixed;
    display:grid;
    place-items:center;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .scrim{position:fixed; inset:0; background:linear-gradient(to bottom, rgba(0,0,32,.25), rgba(0,0,0,.55)); pointer-events:none;}
  .card{
    position:relative;
    width:min(920px, 92vw);
    padding:24px 24px 32px;
    text-align:center;
    backdrop-filter: blur(4px);
  }
  .logo{
    display:block;
    width:min(540px, 80vw);
    max-width:540px;
    margin:0 auto 24px;
    filter: drop-shadow(0 10px 24px var(--shadow));
  }
  .buttons{ display:grid; gap:14px; margin-top:12px; }
  .rb-btn{
    display:block; width:100%;
    border:0; border-radius:16px;
    padding:14px 18px;
    font-weight:700; letter-spacing:.2px;
    text-decoration:none; color:var(--text);
    background:linear-gradient(180deg, var(--btn-start), var(--btn-end));
    box-shadow:0 8px 22px var(--shadow);
    transition: transform .07s ease, box-shadow .2s ease, filter .2s ease;
  }
  .rb-btn:hover{ transform: translateY(-1px); filter:brightness(1.04) }
  .rb-btn:active{ transform: translateY(0); filter:brightness(.97) }
  #gsi{ display:flex; justify-content:center; margin-top:8px; }
  .pending{ margin-top:10px; font-weight:600; text-shadow:0 2px 10px var(--shadow); }
  @media (min-width:640px){ .buttons{ grid-template-columns: repeat(3, 1fr) } }
</style>
</head>
<body>
  <div class="scrim" aria-hidden="true"></div>

  <main class="card">
    <img class="logo" src="RinkBuddy.png" alt="Rink Buddy logo">

    <!-- Signed-out -->
    <div id="signedOut" style="display:none;">
      <div id="gsi"></div>
    </div>

    <!-- Subscription active -->
    <div id="menu" class="buttons" style="display:none;">
      <a class="rb-btn" href="CheckVariance.html">Variance Checks</a>
      <a class="rb-btn" href="templates.html">Rink Templates</a>
      <a class="rb-btn" href="Defaults.html">Default Settings</a>
    </div>

    <!-- Subscription inactive -->
    <div id="pending" class="pending" style="display:none;">
      Account pending activation.
    </div>
  </main>

  <!-- Official Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Firebase v11 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithCredential,
      setPersistence,
      browserLocalPersistence,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ---------- Your Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
      authDomain: "rink-buddy-6f6ed.firebaseapp.com",
      projectId: "rink-buddy-6f6ed",
      storageBucket: "rink-buddy-6f6ed.appspot.com",
      messagingSenderId: "1096930052063",
      appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
      measurementId: "G-7HPRJ6T9LD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persist login so users don't have to click every visit
    await setPersistence(auth, browserLocalPersistence);

    // ---------- UI helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const signedOutEl = $("#signedOut");
    const gsiEl       = $("#gsi");
    const menuEl      = $("#menu");
    const pendingEl   = $("#pending");

    function showSignedOut(){
      signedOutEl.style.display = "";
      menuEl.style.display = "none";
      pendingEl.style.display = "none";
      renderGoogleButton();
    }
    function showMenu(){
      signedOutEl.style.display = "none";
      pendingEl.style.display = "none";
      menuEl.style.display = "";
    }
    function showPending(){
      signedOutEl.style.display = "none";
      menuEl.style.display = "none";
      pendingEl.style.display = "";
    }

    // ---------- Google button (GIS) ----------
    let gsiInitialized = false;
    function renderGoogleButton(){
      if (gsiInitialized) return;

      const clientId = "1096930052063-f8mruob20i6k7s2e1tiem96ic1ek4h4s.apps.googleusercontent.com";

      if (!window.google || !google.accounts || !google.accounts.id) {
        setTimeout(renderGoogleButton, 50);
        return;
      }

      google.accounts.id.initialize({
        client_id: clientId,
        callback: async (response) => {
          try{
            const idToken = response.credential;                   // Google ID token (JWT)
            const cred = GoogleAuthProvider.credential(idToken);   // Convert to Firebase credential
            await signInWithCredential(auth, cred);
            // onAuthStateChanged handles UI afterward
          }catch(err){
            console.error("Sign-in error:", err);
            alert("Google sign-in failed. Please try again.");
          }
        },
        auto_select: false,
        cancel_on_tap_outside: true
      });

      google.accounts.id.renderButton(gsiEl, {
        type: "standard",
        theme: "filled_blue",
        size: "large",
        text: "signin_with",
        shape: "rectangular",
        logo_alignment: "left",
        width: 320
      });

      gsiInitialized = true;
      signedOutEl.style.display = "";
    }

    // ---------- Ensure user doc + create SubscriptionActive ----------
    async function ensureUserDocAndSubscription(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      // Base profile fields to keep updated
      const base = {
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        lastLoginAt: serverTimestamp()
      };

      if (!snap.exists()) {
        // First sign-in: create doc and set SubscriptionActive:false
        await setDoc(ref, {
          ...base,
          createdAt: serverTimestamp(),
          SubscriptionActive: false
        }, { merge: true });
        return false; // not active yet
      } else {
        // Update profile fields
        await setDoc(ref, base, { merge: true });

        // If field is missing, add it as false (one-time)
        const data = snap.data();
        if (typeof data.SubscriptionActive === "undefined") {
          await setDoc(ref, { SubscriptionActive: false }, { merge: true });
          return false;
        }
        return !!data.SubscriptionActive;
      }
    }

    // ---------- Auth state + subscription check ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        showSignedOut();
        return;
      }

      try{
        const active = await ensureUserDocAndSubscription(user);
        if (active) showMenu(); else showPending();
      }catch(err){
        console.error("Subscription check failed:", err);
        showPending(); // conservative fallback
      }
    });

    // Optional helper for testing in console: window.rbSignOut()
    window.rbSignOut = () => signOut(auth);
  </script>
</body>
</html>
