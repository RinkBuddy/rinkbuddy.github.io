<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rink Buddy</title>

<!-- Sporty, bold display font for buttons -->
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">

<style>
  :root{
    --btn-start:#0022ff;   /* your brighter royal */
    --btn-end:#080D85;     /* deep blue */
    --text:#ffffff;
    --shadow: rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    background:#000 url("TitleBackground.png") center/cover no-repeat fixed;
    display:grid;
    grid-template-rows:1fr;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  /* Fixed Logout button (hidden until signed in) */
  #logoutBtn{
    display:none; /* shown when signed in */
    position:fixed; top:12px; right:12px; z-index:1000;
    border:0; border-radius:12px;
    padding:10px 14px;
    font-weight:800;
    background:rgba(0,0,0,.68);
    color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.4);
    cursor:pointer;
    backdrop-filter:saturate(1.2) blur(4px);
    transition:transform .07s ease, filter .2s ease;
  }
  #logoutBtn:hover{ transform:translateY(-1px); filter:brightness(1.07); }

  .scrim{position:fixed; inset:0; background:linear-gradient(to bottom, rgba(0,0,32,.20), rgba(0,0,0,.55)); pointer-events:none;}
  .card{
    align-self:center; justify-self:center;
    width:min(920px, 92vw);
    padding:20px 20px 32px;
    text-align:center;
    backdrop-filter: blur(3px);
  }
  .logo{
    display:block;
    width:min(540px, 80vw);
    max-width:540px;
    margin:0 auto 22px;
    filter: drop-shadow(0 10px 24px var(--shadow));
  }

  /* Stacked buttons */
  .buttons{
    display:flex;
    flex-direction:column;
    gap:16px;
    margin:18px auto 0;
    width:min(560px, 92vw);   /* nice wide buttons, still centered */
  }
  .rb-btn{
    display:block; width:100%;
    border:0; border-radius:18px;
    padding:18px 20px;        /* taller buttons */
    text-decoration:none; color:var(--text);
    background:linear-gradient(180deg, var(--btn-start), var(--btn-end));
    box-shadow:
      0 10px 26px var(--shadow),
      inset 0 0 18px rgba(255,255,255,.10);
    transition: transform .07s ease, filter .2s ease, box-shadow .2s ease;
  }
  .rb-btn:hover{ transform: translateY(-1px); filter:brightness(1.05) }
  .rb-btn:active{ transform: translateY(0); filter:brightness(.97) }

  /* Bigger, more interesting button text */
  .rb-btn span{
    display:block;
    font-family:"Russo One", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    font-size: clamp(20px, 4.2vw, 28px); /* about +40% vs default */
    letter-spacing:.3px;
    text-shadow: 0 2px 12px rgba(0,0,0,.35);
  }

  /* Google button host */
  #gsi{ display:flex; justify-content:center; margin-top:10px; }

  .pending{ margin-top:12px; font-weight:700; text-shadow:0 2px 10px var(--shadow); }
</style>
</head>
<body>
  <!-- Fixed Logout -->
  <button id="logoutBtn" title="Log out">Logout</button>

  <div class="scrim" aria-hidden="true"></div>

  <main class="card">
    <img class="logo" src="RinkBuddy.png" alt="Rink Buddy logo">

    <!-- Signed-out -->
    <div id="signedOut" style="display:none;">
      <div id="gsi"></div>
    </div>

    <!-- Subscription active -->
    <div id="menu" class="buttons" style="display:none;">
      <a class="rb-btn" href="CheckVariance.html"><span>VARIANCE CHECKS</span></a>
      <a class="rb-btn" href="templates.html"><span>RINK TEMPLATES</span></a>
      <a class="rb-btn" href="Defaults.html"><span>DEFAULT SETTINGS</span></a>
    </div>

    <!-- Subscription inactive -->
    <div id="pending" class="pending" style="display:none;">
      Account pending activation.
    </div>
  </main>

  <!-- Official Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Firebase v11 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithCredential,
      setPersistence,
      browserLocalPersistence,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ---------- Firebase config (yours) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
      authDomain: "rink-buddy-6f6ed.firebaseapp.com",
      projectId: "rink-buddy-6f6ed",
      storageBucket: "rink-buddy-6f6ed.appspot.com",
      messagingSenderId: "1096930052063",
      appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
      measurementId: "G-7HPRJ6T9LD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persist login so users don't have to click every visit
    await setPersistence(auth, browserLocalPersistence);

    // ---------- UI helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const signedOutEl = $("#signedOut");
    const gsiEl       = $("#gsi");
    const menuEl      = $("#menu");
    const pendingEl   = $("#pending");
    const logoutBtn   = $("#logoutBtn");

    function showSignedOut(){
      signedOutEl.style.display = "";
      menuEl.style.display = "none";
      pendingEl.style.display = "none";
      logoutBtn.style.display = "none";
      renderGoogleButton();
    }
    function showMenu(){
      signedOutEl.style.display = "none";
      pendingEl.style.display = "none";
      menuEl.style.display = "";
      logoutBtn.style.display = "";  // show logout when signed in
    }
    function showPending(){
      signedOutEl.style.display = "none";
      menuEl.style.display = "none";
      pendingEl.style.display = "";
      logoutBtn.style.display = "";  // still allow logout/change account
    }

    // ---------- Google button (GIS) ----------
    let gsiInitialized = false;
    function renderGoogleButton(){
      if (gsiInitialized) return;

      const clientId = "1096930052063-f8mruob20i6k7s2e1tiem96ic1ek4h4s.apps.googleusercontent.com";

      if (!window.google || !google.accounts || !google.accounts.id) {
        setTimeout(renderGoogleButton, 50);
        return;
      }

      google.accounts.id.initialize({
        client_id: clientId,
        callback: async (response) => {
          try{
            const idToken = response.credential;                   // Google ID token (JWT)
            const cred = GoogleAuthProvider.credential(idToken);   // Convert to Firebase credential
            await signInWithCredential(auth, cred);
            // onAuthStateChanged handles UI afterward
          }catch(err){
            console.error("Sign-in error:", err);
            alert("Google sign-in failed. Please try again.");
          }
        },
        auto_select: false,
        cancel_on_tap_outside: true
      });

      google.accounts.id.renderButton(gsiEl, {
        type: "standard",
        theme: "filled_blue",
        size: "large",
        text: "signin_with",
        shape: "rectangular",
        logo_alignment: "left",
        width: 320
      });

      gsiInitialized = true;
      signedOutEl.style.display = "";
    }

    // ---------- Ensure user doc + create SubscriptionActive if missing ----------
    async function ensureUserDocAndSubscription(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      const base = {
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        lastLoginAt: serverTimestamp()
      };

      if (!snap.exists()) {
        await setDoc(ref, {
          ...base,
          createdAt: serverTimestamp(),
          SubscriptionActive: false
        }, { merge: true });
        return false;
      } else {
        await setDoc(ref, base, { merge: true });
        const data = snap.data();
        if (typeof data.SubscriptionActive === "undefined") {
          await setDoc(ref, { SubscriptionActive: false }, { merge: true });
          return false;
        }
        return !!data.SubscriptionActive;
      }
    }

    // ---------- Auth state + subscription check ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        showSignedOut();
        return;
      }
      try{
        const active = await ensureUserDocAndSubscription(user);
        if (active) showMenu(); else showPending();
      }catch(err){
        console.error("Subscription check failed:", err);
        showPending();
      }
    });

    // ---------- Logout handling (switch accounts cleanly) ----------
    logoutBtn.addEventListener("click", async () => {
      try{
        const u = auth.currentUser;
        if (u && window.google?.accounts?.id?.revoke) {
          // Revoke Google session so user can pick a different account immediately
          window.google.accounts.id.revoke(u.email, () => {});
        }
        await signOut(auth);
        if (window.google?.accounts?.id?.disableAutoSelect) {
          window.google.accounts.id.disableAutoSelect();
        }
        showSignedOut();
      }catch(err){
        console.error("Sign-out error:", err);
        showSignedOut();
      }
    });

    // Optional console helper
    window.rbSignOut = async () => logoutBtn.click();
  </script>
</body>
</html>
