<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rinkbuddy — Check Variance</title>
<style>
  :root { --btn:#1f7aff; --muted:#9fb0d0; --dot-size:40px; --hdrH:64px; --blue:#4da3ff; --gray:#c3c7d1; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:#000; color:#e9eef9; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }

  /* Sticky header / frozen pane (same structure as Templates) */
  header{
    position:sticky; top:0; z-index:30;
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
    padding:10px 12px; background:#0b0d13; border-bottom:1px solid #1b1e27;
  }
  .left,.center,.right{display:flex; gap:10px; align-items:center}
  .center{justify-content:center}
  .right{justify-content:flex-end}

  .btn{
    appearance:none; border:0; border-radius:999px; padding:10px 14px;
    font-weight:700; color:#fff; cursor:pointer; background:var(--btn);
    box-shadow:0 6px 14px rgba(31,122,255,.18);
  }
  .btn.secondary{ background:#22304b; border:1px solid #2b3a59; }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  select{
    background:#121623; color:#fff; border:1px solid #1f2637; border-radius:10px;
    padding:10px 12px; min-width:180px; font-weight:600;
  }
  label{ color:var(--muted); font-weight:700; display:flex; gap:8px; align-items:center }

  .pill{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px;
    background:#1a2033; color:#9ec5ff; border:1px solid #233154;
  }

  /* Stage / viewport (copied pattern) */
  .stage{ display:flex; justify-content:center; align-items:center; width:100%; }
  .viewport{
    position:relative; margin:10px auto 0; border:1px solid #191c26; border-radius:14px;
    overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,.35); background:#000;
  }
  canvas#rink { display:block; width:100%; height:100%; }

  /* Dots: read-only taps */
  .dot{
    position:absolute; transform:translate(-50%,-50%); width:var(--dot-size); height:var(--dot-size);
    border-radius:999px; border:2px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,.4);
    display:grid; place-items:center; color:#000; font-weight:800; user-select:none;
  }
  .dot.gray{ background:var(--gray); }
  .dot.blue{ background:var(--blue); }

  .hint{ color:#9fb0d0; margin:10px 12px 18px }

  /* Desktop fills window neatly */
  @media (min-width: 901px){
    .stage{ min-height: calc(100vh - var(--hdrH)); }
  }

  /* Mobile: header scrolls horizontally; no page scroll; full-bleed rink */
  @media (max-width: 900px){
    html, body { height: 100svh; overflow: hidden; }
    header{
      position:fixed; top:0; left:0; right:0; z-index:40;
      display:flex; gap:10px; align-items:center;
      overflow-x:auto; overflow-y:hidden; white-space:nowrap;
      -webkit-overflow-scrolling:touch; scrollbar-width:none;
    }
    header::-webkit-scrollbar{display:none}
    .left,.center,.right{display:inline-flex; gap:10px; align-items:center}
    .app{ padding-top: var(--hdrH); height: 100svh; overflow:hidden; }
    .stage{ height: calc(100svh - var(--hdrH)); align-items:center; justify-content:center; }
    .viewport{ margin:6px auto 0; }
  }
</style>
</head>
<body>
<header>
  <div class="left">
    <button id="homeBtn" class="btn secondary">Home</button>
    <label>Rink Name:
      <select id="selRink">
        <option>Scotiabank Arena</option>
      </select>
    </label>
    <label>Pad Name:
      <select id="selPad">
        <option>North</option>
      </select>
    </label>
    <label>Employee Name:
      <select id="selEmp">
        <option>Bob</option>
      </select>
    </label>
  </div>

  <div class="center">
    <label style="color:#e9eef9">
      <span style="color:#9fb0d0">Select a template…</span>
      <select id="templateSelect" style="min-width:260px">
        <option value="">Select a template…</option>
      </select>
    </label>
  </div>

  <div class="right">
    <span id="bleStatus" class="pill">disconnected</span>
    <button id="connectBtn" class="btn">Connect</button>
    <button id="saveBtn" class="btn secondary" disabled>Save</button>
  </div>
</header>

<div class="app">
  <div class="stage">
    <div id="view" class="viewport">
      <canvas id="rink"></canvas>
    </div>
  </div>
</div>

<p class="hint">Tap a dot to send “?”. When the device replies, the dot turns blue and shows the value.</p>

<script type="module">
/* -------------------- Firebase (Auth + Firestore) -------------------- */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup,
  onAuthStateChanged, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import {
  getFirestore, doc, collection, getDocs, getDoc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* your project */
const firebaseConfig = {
  apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
  authDomain: "rink-buddy-6f6ed.firebaseapp.com",
  projectId: "rink-buddy-6f6ed",
  storageBucket: "rink-buddy-6f6ed.appspot.com",
  messagingSenderId: "1096930052063",
  appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
  measurementId: "G-7HPRJ6T9LD"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* persist across pages/tabs */
await setPersistence(auth, browserLocalPersistence);

/* -------------------- DOM refs -------------------- */
const view = document.getElementById('view');
const canvas = document.getElementById('rink');
const ctx = canvas.getContext('2d', { willReadFrequently:true });

const homeBtn = document.getElementById('homeBtn');
const templateSelect = document.getElementById('templateSelect');

const selRink = document.getElementById('selRink');
const selPad  = document.getElementById('selPad');
const selEmp  = document.getElementById('selEmp');

const connectBtn = document.getElementById('connectBtn');
const saveBtn = document.getElementById('saveBtn');
const bleStatus = document.getElementById('bleStatus');

/* -------------------- App state (mirrors Templates page behavior) -------------------- */
const img = new Image(); img.src = 'rink1.png';

const state = {
  naturalW: 600, naturalH: 1200,   // portrait source
  mobile: false,
  rotated: false,                  // rotate CW for desktop display
  centerY: 0.5,
  points: [],                      // from template: [{id,u,v,mode}]
  labelsForSide: new Map(),        // optional numeric labels from template
  uid: null,
  allNames: [],
  currentName: null,
  readings: [],                    // [{key, value, u, v}]
};

/* -------------------- Auth gate -------------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    const provider = new GoogleAuthProvider();
    try { await signInWithPopup(auth, provider); } catch(e){ console.warn(e); }
    return;
  }
  state.uid = user.uid;
  await refreshTemplateList();
  await ensureCanvasReady();
});

/* -------------------- Firestore helpers -------------------- */
function userDocRef(uid){ return doc(db, 'users', uid); }
function templatesColRef(uid){ return collection(userDocRef(uid), 'templates'); }
function templateDocRef(uid, name){ return doc(templatesColRef(uid), name); }

async function refreshTemplateList(){
  if (!state.uid) return;
  const snap = await getDocs(templatesColRef(state.uid));
  state.allNames = snap.docs.map(d=>d.id).sort((a,b)=> a.localeCompare(b));
  templateSelect.innerHTML = `<option value="">Select a template…</option>`;
  state.allNames.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n; opt.textContent = n;
    templateSelect.appendChild(opt);
  });
}

async function loadTemplateByName(name){
  const ref = templateDocRef(state.uid, name);
  const docSnap = await getDoc(ref);
  if (!docSnap.exists()) return false;
  const data = docSnap.data();

  state.centerY = typeof data.centerY === 'number' ? data.centerY : 0.5;
  if (typeof data.imgW === 'number') state.naturalW = data.imgW;
  if (typeof data.imgH === 'number') state.naturalH = data.imgH;

  state.points = Array.isArray(data.points) ? data.points.map(p=>({
    id: p.id || `pt_${Math.random().toString(36).slice(2,8)}`,
    u: +p.u, v: +p.v,
    mode: p.mode==='single' ? 'single' : 'mirrored',
    labels: p.labels || null
  })) : [];

  state.labelsForSide.clear();
  for (const p of state.points){
    if (p.labels){
      for (const side of Object.keys(p.labels)){
        state.labelsForSide.set(`${p.id}:${side}`, String(p.labels[side]));
      }
    }
  }

  state.currentName = name;
  renderAll();
  return true;
}

/* -------------------- Header actions -------------------- */
homeBtn.addEventListener('click', ()=>{ window.location.href = 'index.html'; });
templateSelect.addEventListener('change', async (e)=>{
  const name = e.target.value;
  state.readings = [];
  saveBtn.disabled = true;
  if (!name){ clearDots(); drawRink(); return; }
  await loadTemplateByName(name);
});

/* -------------------- Canvas layout (IDENTICAL to Templates) -------------------- */
function setCanvasSize(w,h){
  canvas.width  = Math.max(1, Math.round(w));
  canvas.height = Math.max(1, Math.round(h));
  view.style.width  = canvas.width + 'px';
  view.style.height = canvas.height + 'px';
}

function applyLayout(){
  const headerH = document.querySelector('header').offsetHeight || 64;
  document.documentElement.style.setProperty('--hdrH', headerH + 'px');

  state.mobile = window.matchMedia('(max-width: 900px)').matches;
  const imageIsVertical = state.naturalH > state.naturalW;
  const wantVertical    = state.mobile;                 // portrait on mobile, landscape on desktop
  state.rotated = (wantVertical !== imageIsVertical);   // desktop => true (rotate CW 90°)

  let availW, availH;
  if (state.mobile){
    const stage = document.querySelector('.stage');
    availW = Math.max(1, stage.clientWidth  - 12);
    availH = Math.max(1, stage.clientHeight - 12);
    if (availW <= 1 || availH <= 1) { requestAnimationFrame(applyLayout); return; }
  } else {
    availW = Math.max(1, window.innerWidth  - 24);
    availH = Math.max(1, window.innerHeight - headerH - 24);
  }

  const aspect = state.rotated ? (state.naturalH/state.naturalW) : (state.naturalW/state.naturalH);
  let w = availW, h = w/aspect; if (h>availH){ h=availH; w=h*aspect; }
  setCanvasSize(w,h);

  const d = Math.max(2, Math.round(Math.min(canvas.width, canvas.height) * 0.10));
  document.documentElement.style.setProperty('--dot-size', d + 'px');

  drawRink();
  renderDots();
}

function drawRink(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (state.rotated){
    // EXACT rotation used by Templates page (CW visually)
    ctx.save();
    ctx.translate(0, canvas.height);
    ctx.rotate(-Math.PI/2);
    ctx.drawImage(img, 0, 0, canvas.height, canvas.width);
    ctx.restore();
  } else {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }
}

/* UV -> canvas mapping (same as Templates) */
function uvToCanvas(u,v){
  const W=canvas.width, H=canvas.height;
  if (state.mobile) return { x: u*W, y: v*H };     // portrait
  return { x: v*W, y: (1 - u)*H };                 // desktop
}

/* -------------------- Dots (read-only) -------------------- */
function clearDots(){ view.querySelectorAll('.dot').forEach(n=>n.remove()); }

function renderDots(){
  clearDots();
  if (!state.points.length) return;

  state.points.forEach((pt) => {
    if (pt.mode === 'single'){
      addDotAtUV(pt, 'single');
    } else {
      const vTop = Math.min(pt.v, 2*state.centerY - pt.v);
      const vBot = Math.max(pt.v, 2*state.centerY - pt.v);
      addDotAtUV({u:pt.u, v:vTop, id:pt.id}, 'top');
      addDotAtUV({u:pt.u, v:vBot, id:pt.id}, 'bottom');
    }
  });
}

function addDotAtUV(p, side){
  const pos = uvToCanvas(p.u, p.v);
  const d = document.createElement('button');
  d.type = 'button';
  d.className = 'dot gray';
  d.style.left = (pos.x/canvas.width*100)+'%';
  d.style.top  = (pos.y/canvas.height*100)+'%';

  const key = `${p.id}:${side}`;
  const initialLabel = state.labelsForSide.get(key) || '';
  d.textContent = initialLabel;

  d.dataset.key = key;
  d.dataset.id = p.id;
  d.dataset.side = side;
  d.dataset.u = String(p.u);
  d.dataset.v = String(p.v);

  d.addEventListener('click', () => requestReadingForDot(d));
  view.appendChild(d);
}

function renderAll(){ drawRink(); renderDots(); }

/* Boot canvas once image is ready */
async function ensureCanvasReady(){
  if (img.complete) {
    state.naturalW = img.naturalWidth  || state.naturalW;
    state.naturalH = img.naturalHeight || state.naturalH;
    applyLayout();
  } else {
    await new Promise(res=>{
      img.onload = ()=>{ state.naturalW=img.naturalWidth||state.naturalW;
                         state.naturalH=img.naturalHeight||state.naturalH;
                         applyLayout(); res(); };
    });
  }
}
window.addEventListener('resize', applyLayout);
window.addEventListener('orientationchange', applyLayout);
new ResizeObserver(applyLayout).observe(document.querySelector('header'));

/* -------------------- BLE (Nordic UART, “?” flow preserved) -------------------- */
const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write / writeNR
const NUS_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

const enc = new TextEncoder();
const dec = new TextDecoder();

let ble = { device:null, server:null, service:null, rx:null, tx:null, connected:false };
let inFlight = false;
let pendingDot = null;
let askTimer = null;

function setBleUI(connected){
  bleStatus.textContent = connected ? 'connected' : 'disconnected';
  bleStatus.style.background = connected ? '#13301f' : '#1a2033';
  bleStatus.style.color = connected ? '#95ffb5' : '#9ec5ff';
}

async function connectBle(){
  try{
    if (!('bluetooth' in navigator)) { alert('Use Chrome/Edge over HTTPS for Web Bluetooth.'); return; }
    const device = await navigator.bluetooth.requestDevice({
      filters:[{ name: 'BUDDY' }],
      optionalServices:[NUS_SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', () => { ble.connected=false; setBleUI(false); });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(NUS_SERVICE_UUID);
    const tx = await service.getCharacteristic(NUS_TX_CHAR_UUID);
    await tx.startNotifications();
    tx.addEventListener('characteristicvaluechanged', handleNotify);
    const rx = await service.getCharacteristic(NUS_RX_CHAR_UUID);

    ble = { device, server, service, rx, tx, connected:true };
    setBleUI(true);
  } catch(err){
    console.error(err);
    ble.connected = false; setBleUI(false);
  }
}

function handleNotify(ev){
  const text = dec.decode(ev.target.value).trim();
  const value = parseIncomingValue(text);
  inFlight = false; clearTimeout(askTimer);

  if (pendingDot){
    pendingDot.classList.remove('gray');
    pendingDot.classList.add('blue');
    pendingDot.textContent = value;

    const key = pendingDot.dataset.key;
    const u = +pendingDot.dataset.u, v = +pendingDot.dataset.v;
    upsertReading(key, value, u, v);

    pendingDot = null;
    saveBtn.disabled = state.readings.length === 0;
  }
}

function parseIncomingValue(t){
  const m = t.match(/-?\d+(\.\d+)?/);
  return m ? m[0] : t;
}

async function sendRaw(str){
  if (!ble.connected || !ble.rx) return;
  try{ await ble.rx.writeValueWithoutResponse(enc.encode(str)); }
  catch(err){ console.error('BLE send error', err); }
}

async function requestReadingForDot(dotEl){
  if (!ble.connected){ alert('Connect to the BLE device first.'); return; }
  if (inFlight) return;
  pendingDot = dotEl;
  inFlight = true;
  await sendRaw('?');
  clearTimeout(askTimer);
  askTimer = setTimeout(()=>{ if(inFlight){ inFlight=false; pendingDot=null; alert('No response within 2s.'); } }, 2000);
}

function upsertReading(key, value, u, v){
  const i = state.readings.findIndex(r=>r.key===key);
  const rec = { key, value, u, v };
  if (i>=0) state.readings[i] = rec; else state.readings.push(rec);
}

/* -------------------- Save variance -------------------- */
async function saveVariance(){
  if (!state.uid){ alert('Sign in required.'); return; }
  if (!state.currentName){ alert('Pick a template first.'); return; }
  if (!state.readings.length){ alert('Take at least one reading.'); return; }

  const payload = {
    templateName: state.currentName,
    rinkName: selRink.value,
    padName: selPad.value,
    employeeName: selEmp.value,
    readings: state.readings,              // [{key, value, u, v}]
    centerY: state.centerY,
    createdAt: serverTimestamp(),
    imgW: state.naturalW, imgH: state.naturalH
  };

  try{
    const col = collection(userDocRef(state.uid), 'variances');
    await addDoc(col, payload);
    alert('Variance saved.');
  }catch(err){
    console.error(err);
    alert('Save failed. See console.');
  }
}

/* -------------------- Wire up UI -------------------- */
connectBtn.addEventListener('click', connectBle);
saveBtn.addEventListener('click', saveVariance);

/* Minor helpers */
function userDocRef(uid){ return doc(db, 'users', uid); }

/* Prevent ghost-drag */
document.addEventListener('dragstart', e => { if (e.target.tagName==='IMG') e.preventDefault(); }, {capture:true});
</script>
</body>
</html>
