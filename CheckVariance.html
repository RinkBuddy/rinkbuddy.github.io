<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rinkbuddy — Check Variance</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#0b0d12; --line:#1c2030; --fg:#e6e6e6; --muted:#9aa4b2;
      --accent:#4da3ff; --ok:#4da3ff; --dot-gray:#9aa4b2; --dot-blue:#4da3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Frozen pane */
    .bar{
      position:sticky; top:0; z-index:10;
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px;
      padding:10px 12px; background:var(--panel); border-bottom:1px solid var(--line);
    }
    .left, .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .center{ display:flex; justify-content:center }
    label{display:flex; align-items:center; gap:6px; color:var(--muted); font-weight:600}
    select{
      background:#0b0f1a; color:var(--fg); border:1px solid #22283b; border-radius:10px;
      padding:8px 10px; min-width:160px; outline:none;
    }
    .btn{
      background:var(--accent); color:#000; border:0; border-radius:10px; padding:10px 14px;
      font-weight:700; cursor:pointer; white-space:nowrap;
    }
    .btn.secondary{ background:#2a2f42; color:var(--fg) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    /* Canvas area */
    main{ max-width:1100px; margin:16px auto; padding:0 12px 24px }
    .rinkWrap{
      position:relative; width:100%;
      /* Lock aspect like the templates page; we’ll refine to the image’s ratio on load */
      aspect-ratio: 2 / 1;
      background:#0b0d12; border:1px solid #22283b; border-radius:14px; overflow:hidden;
    }
    .rinkWrap img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
      user-select:none; -webkit-user-drag:none; pointer-events:none;
    }
    .dot{
      position:absolute; width:34px; height:34px; border-radius:999px;
      transform:translate(-50%, -50%);
      display:grid; place-items:center; font-weight:800; font-size:12px;
      border:2px solid rgba(0,0,0,.35); cursor:pointer;
      color:#0b0d12; /* text color when blue */
    }
    .dot.gray{ background:var(--dot-gray); color:#0b0d12 }
    .dot.blue{ background:var(--dot-blue); color:#0b0d12 }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 }

    /* Status pill */
    .pill{ display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px;
      background:#1a2033; color:#9ec5ff; border:1px solid #233154; margin-left:8px }

    /* Small helper */
    .spacer{ flex:1 }
  </style>
</head>
<body>
  <!-- Frozen pane -->
  <div class="bar">
    <div class="left">
      <button class="btn secondary" id="btnHome" title="Go to index.html">Home</button>
      <label>Rink Name:
        <select id="selRink">
          <option>Scotiabank Arena</option>
        </select>
      </label>
      <label>Pad Name:
        <select id="selPad">
          <option>North</option>
        </select>
      </label>
      <label>Employee Name:
        <select id="selEmp">
          <option>Bob</option>
        </select>
      </label>
    </div>

    <div class="center">
      <label style="gap:10px;color:var(--fg)">
        <span style="color:var(--muted)">Select a template…</span>
        <select id="selTemplate" style="min-width:220px">
          <option value="">— Select —</option>
        </select>
      </label>
    </div>

    <div class="right">
      <span id="bleStatus" class="pill">disconnected</span>
      <button class="btn" id="btnConnect">Connect</button>
      <button class="btn secondary" id="btnSave" disabled>Save</button>
    </div>
  </div>

  <main>
    <div class="rinkWrap" id="rink">
      <img id="rinkImg" alt="Rink" src="rink1.png">
      <!-- dots get injected here -->
    </div>

    <div class="row muted" id="hint">
      • Tap a dot to query the device (sends “?”). The dot turns blue and shows the value when a reply arrives.
    </div>
  </main>

  <script type="module">
    /**** Firebase (v11) ****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
      authDomain: "rink-buddy-6f6ed.firebaseapp.com",
      projectId: "rink-buddy-6f6ed",
      storageBucket: "rink-buddy-6f6ed.appspot.com",
      messagingSenderId: "1096930052063",
      appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
      measurementId: "G-7HPRJ6T9LD"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence);

    const $ = s => document.querySelector(s);
    const rinkEl = $('#rink');
    const rinkImg = $('#rinkImg');
    const selTemplate = $('#selTemplate');
    const selRink = $('#selRink');
    const selPad  = $('#selPad');
    const selEmp  = $('#selEmp');
    const btnHome = $('#btnHome');
    const btnConnect = $('#btnConnect');
    const btnSave = $('#btnSave');
    const bleStatus = $('#bleStatus');

    let user = null;
    let templatesIdx = {}; // templateId -> template doc
    let currentTemplate = null;
    let readings = []; // {index,label,value}

    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        // Light-touch: prompt when needed. For convenience we’ll sign-in up front:
        try {
          const provider = new GoogleAuthProvider();
          user = (await signInWithPopup(auth, provider)).user;
        } catch (e) {
          console.warn('Auth required for Firestore access.', e);
          user = null;
        }
      } else {
        user = u;
      }
      if (user) {
        await loadSettingsAndTemplates();
      }
    });

    async function loadSettingsAndTemplates() {
      try {
        // Settings (dropdowns)
        const sRef = doc(db, 'users', user.uid, 'meta', 'settings');
        const sSnap = await getDoc(sRef);
        const defaults = {
          rinkNames: ['Scotiabank Arena'],
          padNames: ['North'],
          employeeNames: ['Bob'],
        };
        const data = sSnap.exists() ? sSnap.data() : defaults;

        fillSelect(selRink, data.rinkNames?.length ? data.rinkNames : defaults.rinkNames);
        fillSelect(selPad,  data.padNames?.length ? data.padNames : defaults.padNames);
        fillSelect(selEmp,  data.employeeNames?.length ? data.employeeNames : defaults.employeeNames);

        // Templates
        const tCol = collection(db, 'users', user.uid, 'templates');
        const tSnap = await getDocs(tCol);
        const options = [];
        templatesIdx = {};
        tSnap.forEach(d => {
          const v = d.data();
          const name = v.name || d.id;
          templatesIdx[d.id] = { id:d.id, ...v };
          options.push({ value:d.id, label:name });
        });
        fillSelect(selTemplate, [{value:'',label:'— Select —'}, ...options]);
      } catch (err) {
        console.error(err);
      }
    }

    function fillSelect(sel, items){
      const cur = sel.value;
      sel.innerHTML = '';
      for (const it of items){
        if (typeof it === 'string') {
          const opt = document.createElement('option');
          opt.textContent = it; opt.value = it;
          sel.appendChild(opt);
        } else {
          const opt = document.createElement('option');
          opt.textContent = it.label; opt.value = it.value;
          sel.appendChild(opt);
        }
      }
      // keep prior value if possible
      if ([...sel.options].some(o=>o.value===cur)) sel.value = cur;
    }

    btnHome.addEventListener('click', () => { location.href = 'index.html'; });

    // Maintain the container aspect to the image’s intrinsic ratio so it matches the templates page.
    rinkImg.addEventListener('load', () => {
      try {
        const ratio = rinkImg.naturalWidth / rinkImg.naturalHeight;
        rinkEl.style.aspectRatio = `${ratio} / 1`;
        // The CSS aspect-ratio expects width/height. We’ll do width:height directly:
        rinkEl.style.aspectRatio = `${rinkImg.naturalWidth} / ${rinkImg.naturalHeight}`;
      } catch(e){}
    });

    selTemplate.addEventListener('change', () => {
      const id = selTemplate.value;
      currentTemplate = id ? templatesIdx[id] : null;
      readings = [];
      renderDots(currentTemplate?.points || []);
      btnSave.disabled = true; // until at least one reading exists
    });

    function renderDots(points){
      // Clear existing dots
      rinkEl.querySelectorAll('.dot').forEach(n => n.remove());
      if (!points || !points.length) return;

      // Render all dots as light gray, non-movable
      points.forEach((p, idx) => {
        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'dot gray';
        dot.style.left = `${clamp01(p.x)*100}%`;
        dot.style.top  = `${clamp01(p.y)*100}%`;
        dot.title = p.label ? `Point ${p.label}` : `Point ${idx+1}`;
        dot.dataset.index = idx;
        dot.dataset.label = p.label ?? String(idx+1);
        dot.textContent = p.label ?? String(idx+1);
        dot.addEventListener('click', () => requestReadingForDot(dot));
        rinkEl.appendChild(dot);
      });
    }

    function clamp01(v){ return Math.min(1, Math.max(0, Number(v))) }

    /**** BLE (Nordic UART) ****/
    const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write / writeNR
    const NUS_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    let ble = { device:null, server:null, service:null, rx:null, tx:null, connected:false };
    let inFlight = false;
    let askTimer = null;
    let pendingDot = null; // which dot we’re expecting to fill next

    function setBleUI(connected){
      bleStatus.textContent = connected ? 'connected' : 'disconnected';
      bleStatus.style.background = connected ? '#13301f' : '#1a2033';
      bleStatus.style.color = connected ? '#95ffb5' : '#9ec5ff';
    }
    setBleUI(false);

    async function connectBle(){
      try{
        if (!('bluetooth' in navigator)) {
          alert('Web Bluetooth not supported in this browser. Use Chrome/Edge over HTTPS.');
          return;
        }
        const device = await navigator.bluetooth.requestDevice({
          filters:[{ name: 'BUDDY' }],
          optionalServices:[NUS_SERVICE_UUID]
        });
        device.addEventListener('gattserverdisconnected', () => {
          ble.connected = false; setBleUI(false);
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(NUS_SERVICE_UUID);
        const tx = await service.getCharacteristic(NUS_TX_CHAR_UUID);
        await tx.startNotifications();
        tx.addEventListener('characteristicvaluechanged', handleNotify);
        const rx = await service.getCharacteristic(NUS_RX_CHAR_UUID);

        ble = { device, server, service, rx, tx, connected:true };
        setBleUI(true);
      } catch(err){
        console.error(err);
        ble.connected = false; setBleUI(false);
      }
    }

    function handleNotify(ev){
      const text = dec.decode(ev.target.value).trim();
      // Interpret like before: we sent “?”, we expect latest value frame.
      const value = parseIncomingValue(text);
      inFlight = false;
      clearTimeout(askTimer);

      if (pendingDot){
        // Fill the dot visually + record the reading
        pendingDot.classList.remove('gray');
        pendingDot.classList.add('blue');
        pendingDot.textContent = value;
        const idx = Number(pendingDot.dataset.index);
        const label = pendingDot.dataset.label;
        upsertReading(idx, label, value);
        pendingDot = null;
        btnSave.disabled = readings.length === 0;
      }
    }

    function parseIncomingValue(t){
      // Best effort:
      // 1) try to find a float in the string
      const m = t.match(/-?\d+(\.\d+)?/);
      if (m) return m[0];
      // 2) fallback to full text (some frames may already be ascii-decoded upstream)
      return t;
    }

    async function sendRaw(str){
      if (!ble.connected || !ble.rx) return;
      try{
        await ble.rx.writeValueWithoutResponse(enc.encode(str));
      }catch(err){ console.error('BLE send error', err); }
    }

    async function requestReadingForDot(dotEl){
      if (!ble.connected){ alert('Connect to the BLE device first.'); return; }
      if (inFlight) return; // prevent spam
      pendingDot = dotEl;
      inFlight = true;
      await sendRaw('?');

      clearTimeout(askTimer);
      askTimer = setTimeout(() => {
        if (inFlight){
          inFlight = false;
          pendingDot = null;
          alert('No response from device within 2 seconds.');
        }
      }, 2000);
    }

    function upsertReading(index, label, value){
      const pos = readings.findIndex(r => r.index === index);
      if (pos >= 0) readings[pos] = { index, label, value };
      else readings.push({ index, label, value });
    }

    /**** SAVE to Firestore (variances) ****/
    async function saveVariance(){
      if (!user){ alert('Sign in required.'); return; }
      if (!currentTemplate){ alert('Pick a template first.'); return; }
      if (readings.length === 0){ alert('Take at least one reading.'); return; }

      const payload = {
        templateId: currentTemplate.id,
        templateName: currentTemplate.name || currentTemplate.id,
        rinkName: selRink.value,
        padName: selPad.value,
        employeeName: selEmp.value,
        readings, // [{index,label,value}]
        createdAt: serverTimestamp()
      };
      try {
        const col = collection(db, 'users', user.uid, 'variances');
        await addDoc(col, payload);
        alert('Variance saved.');
      } catch (err){
        console.error(err);
        alert('Save failed. Check console.');
      }
    }

    /**** Wire up UI ****/
    btnConnect.addEventListener('click', connectBle);
    btnSave.addEventListener('click', saveVariance);

    // Prevent accidental image drag/ghost
    document.addEventListener('dragstart', e => { if (e.target.tagName==='IMG') e.preventDefault(); }, {capture:true});
  </script>
</body>
</html>
