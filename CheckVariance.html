<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rinkbuddy — Check Variance</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#0b0d12; --line:#1c2030; --fg:#e6e6e6; --muted:#9aa4b2;
      --accent:#4da3ff; --dot-gray:#c3c7d1; --dot-blue:#4da3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Frozen pane */
    .bar{
      position:sticky; top:0; z-index:10;
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px;
      padding:10px 12px; background:var(--panel); border-bottom:1px solid var(--line);
    }
    .left, .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .center{ display:flex; justify-content:center }
    label{display:flex; align-items:center; gap:6px; color:var(--muted); font-weight:600}
    select{
      background:#0b0f1a; color:var(--fg); border:1px solid #22283b; border-radius:10px;
      padding:8px 10px; min-width:160px; outline:none;
    }
    .btn{
      background:var(--accent); color:#000; border:0; border-radius:10px; padding:10px 14px;
      font-weight:700; cursor:pointer; white-space:nowrap;
    }
    .btn.secondary{ background:#2a2f42; color:var(--fg) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .pill{ display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px;
      background:#1a2033; color:#9ec5ff; border:1px solid #233154; margin-left:8px }

    main{ max-width:1100px; margin:16px auto; padding:0 12px 24px }

    /* Force horizontal rink on desktop; refine to image ratio on load */
    .rinkWrap{
      position:relative; width:100%;
      aspect-ratio: 200 / 85;          /* strong landscape default (horizontal) */
      background:#0b0d12; border:1px solid #22283b; border-radius:14px; overflow:hidden;
    }
    @media (max-width: 720px){
      .rinkWrap{ aspect-ratio: 200 / 100; } /* still landscape on mobile, just a bit taller */
    }

    .rinkWrap img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
      user-select:none; -webkit-user-drag:none; pointer-events:none;
    }

    .dot{
      position:absolute; width:34px; height:34px; border-radius:999px;
      transform:translate(-50%, -50%);
      display:grid; place-items:center; font-weight:800; font-size:12px;
      border:2px solid rgba(0,0,0,.35); cursor:pointer;
      transition:transform .06s ease;
    }
    .dot:active{ transform:translate(-50%,-50%) scale(0.97) }
    .dot.gray{ background:var(--dot-gray); color:#0b0d12 }
    .dot.blue{ background:var(--dot-blue); color:#0b0d12 }

    .muted{ color:var(--muted) }
  </style>
</head>
<body>
  <!-- Frozen pane -->
  <div class="bar">
    <div class="left">
      <button class="btn secondary" id="btnHome" title="Go to index.html">Home</button>
      <label>Rink Name:
        <select id="selRink">
          <option>Scotiabank Arena</option>
        </select>
      </label>
      <label>Pad Name:
        <select id="selPad">
          <option>North</option>
        </select>
      </label>
      <label>Employee Name:
        <select id="selEmp">
          <option>Bob</option>
        </select>
      </label>
    </div>

    <div class="center">
      <label style="gap:10px;color:var(--fg)">
        <span style="color:var(--muted)">Select a template…</span>
        <select id="selTemplate" style="min-width:220px">
          <option value="">— Select —</option>
        </select>
      </label>
    </div>

    <div class="right">
      <span id="bleStatus" class="pill">disconnected</span>
      <button class="btn" id="btnConnect">Connect</button>
      <button class="btn secondary" id="btnSave" disabled>Save</button>
    </div>
  </div>

  <main>
    <div class="rinkWrap" id="rink">
      <img id="rinkImg" alt="Rink" src="rink1.png">
      <!-- dots injected here -->
    </div>

    <p class="muted" style="margin-top:12px">
      • Tap a dot to query the device (sends “?”). The dot turns blue and shows the value when a reply arrives.
    </p>
  </main>

  <script type="module">
    /********************  Firebase v11  ********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYlPYVyeUMpcr8qgUTifHJiOCayhh7QCQ",
      authDomain: "rink-buddy-6f6ed.firebaseapp.com",
      projectId: "rink-buddy-6f6ed",
      storageBucket: "rink-buddy-6f6ed.appspot.com",
      messagingSenderId: "1096930052063",
      appId: "1:1096930052063:web:6b97608f1cdd3f5111666a",
      measurementId: "G-7HPRJ6T9LD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence);

    /********************  DOM refs  ********************/
    const $ = s => document.querySelector(s);
    const rinkEl = $('#rink');
    const rinkImg = $('#rinkImg');
    const selTemplate = $('#selTemplate');
    const selRink = $('#selRink');
    const selPad  = $('#selPad');
    const selEmp  = $('#selEmp');
    const btnHome = $('#btnHome');
    const btnConnect = $('#btnConnect');
    const btnSave = $('#btnSave');
    const bleStatus = $('#bleStatus');

    /********************  State  ********************/
    let user = null;
    let templatesIdx = {};     // templateId -> doc
    let currentTemplate = null;
    let readings = [];         // [{index,label,value}]
    let imgReady = false;      // true after rink1.png has loaded
    let lastRenderedTemplateId = null;

    /********************  Auth & initial data  ********************/
    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        try {
          const provider = new GoogleAuthProvider();
          user = (await signInWithPopup(auth, provider)).user;
        } catch (e) {
          console.warn('Auth required for Firestore access.', e);
          user = null;
        }
      } else {
        user = u;
      }
      if (user) {
        await loadSettingsAndTemplates();
      }
    });

    async function loadSettingsAndTemplates() {
      try {
        // Settings dropdowns
        const sRef = doc(db, 'users', user.uid, 'meta', 'settings');
        const sSnap = await getDoc(sRef);
        const defaults = {
          rinkNames: ['Scotiabank Arena'],
          padNames: ['North'],
          employeeNames: ['Bob'],
        };
        const data = sSnap.exists() ? sSnap.data() : defaults;
        fillSelect(selRink, data.rinkNames?.length ? data.rinkNames : defaults.rinkNames);
        fillSelect(selPad,  data.padNames?.length ? data.padNames : defaults.padNames);
        fillSelect(selEmp,  data.employeeNames?.length ? data.employeeNames : defaults.employeeNames);

        // Templates list
        const tCol = collection(db, 'users', user.uid, 'templates');
        const tSnap = await getDocs(tCol);
        templatesIdx = {};
        const opts = [{ value:'', label:'— Select —' }];
        tSnap.forEach(d => {
          const v = d.data();
          const name = v.name || d.id;
          templatesIdx[d.id] = { id:d.id, ...v };
          opts.push({ value:d.id, label:name });
        });
        fillSelect(selTemplate, opts);
      } catch (err) {
        console.error(err);
      }
    }

    function fillSelect(sel, items){
      const cur = sel.value;
      sel.innerHTML = '';
      for (const it of items){
        const opt = document.createElement('option');
        if (typeof it === 'string'){ opt.value = it; opt.textContent = it; }
        else { opt.value = it.value; opt.textContent = it.label; }
        sel.appendChild(opt);
      }
      if ([...sel.options].some(o=>o.value===cur)) sel.value = cur;
    }

    btnHome.addEventListener('click', () => { location.href = 'index.html'; });

    /********************  Rink image ratio (keep horizontal)  ********************/
    rinkImg.addEventListener('load', () => {
      // Ensure horizontal aspect and accurate ratio once the image is known
      const natW = rinkImg.naturalWidth || 2000;
      const natH = rinkImg.naturalHeight || 850;
      rinkEl.style.aspectRatio = `${natW} / ${natH}`;
      imgReady = true;

      // If a template was already selected but dots didn't render yet, (re)render now
      if (currentTemplate && lastRenderedTemplateId !== currentTemplate.id) {
        renderDots(currentTemplate.points || [], currentTemplate);
        lastRenderedTemplateId = currentTemplate.id;
      }
    });

    // In case the image was cached and already complete before the event registered
    if (rinkImg.complete) {
      rinkImg.dispatchEvent(new Event('load'));
    }

    /********************  Template selection & dot rendering  ********************/
    selTemplate.addEventListener('change', () => {
      const id = selTemplate.value;
      currentTemplate = id ? templatesIdx[id] : null;
      readings = [];
      btnSave.disabled = true;

      // If the image is ready, render immediately; otherwise render on image load
      if (currentTemplate) {
        if (imgReady) {
          renderDots(currentTemplate.points || [], currentTemplate);
          lastRenderedTemplateId = currentTemplate.id;
        } else {
          // Clear any prior dots; they will be placed on load
          clearDots();
          lastRenderedTemplateId = null;
        }
      } else {
        clearDots();
        lastRenderedTemplateId = null;
      }
    });

    function clearDots(){
      rinkEl.querySelectorAll('.dot').forEach(n => n.remove());
    }

    function isNormalizedPoint(p){
      return p && typeof p.x === 'number' && typeof p.y === 'number' &&
             p.x >= 0 && p.x <= 1 && p.y >= 0 && p.y <= 1;
    }

    function toPercentPos(p, tpl){
      // Accept normalized or pixel-based points.
      // If pixel-based, try to use template baseWidth/baseHeight, else fall back to image natural size.
      if (isNormalizedPoint(p)){
        return { leftPct: p.x * 100, topPct: p.y * 100 };
      } else {
        const baseW = (tpl && tpl.baseWidth)  || rinkImg.naturalWidth  || 2000;
        const baseH = (tpl && tpl.baseHeight) || rinkImg.naturalHeight || 850;
        return { leftPct: (p.x / baseW) * 100, topPct: (p.y / baseH) * 100 };
      }
    }

    function renderDots(points, tpl){
      clearDots();
      if (!points || !points.length) return;

      // Ensure layout is ready
      requestAnimationFrame(() => {
        points.forEach((p, idx) => {
          const { leftPct, topPct } = toPercentPos(p, tpl);
          const dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'dot gray';
          dot.style.left = `${Math.min(100, Math.max(0, leftPct))}%`;
          dot.style.top  = `${Math.min(100, Math.max(0, topPct))}%`;
          dot.title = p.label ? `Point ${p.label}` : `Point ${idx+1}`;
          dot.dataset.index = idx;
          dot.dataset.label = p.label ?? String(idx+1);
          dot.textContent = p.label ?? String(idx+1);
          dot.addEventListener('click', () => requestReadingForDot(dot));
          rinkEl.appendChild(dot);
        });
      });
    }

    /********************  BLE (Nordic UART)  ********************/
    const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write / writeNR
    const NUS_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    let ble = { device:null, server:null, service:null, rx:null, tx:null, connected:false };
    let inFlight = false;
    let askTimer = null;
    let pendingDot = null;

    function setBleUI(connected){
      bleStatus.textContent = connected ? 'connected' : 'disconnected';
      bleStatus.style.background = connected ? '#13301f' : '#1a2033';
      bleStatus.style.color = connected ? '#95ffb5' : '#9ec5ff';
    }
    setBleUI(false);

    async function connectBle(){
      try{
        if (!('bluetooth' in navigator)) {
          alert('Web Bluetooth not supported in this browser. Use Chrome/Edge over HTTPS.');
          return;
        }
        const device = await navigator.bluetooth.requestDevice({
          filters:[{ name: 'BUDDY' }],
          optionalServices:[NUS_SERVICE_UUID]
        });
        device.addEventListener('gattserverdisconnected', () => {
          ble.connected = false; setBleUI(false);
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(NUS_SERVICE_UUID);
        const tx = await service.getCharacteristic(NUS_TX_CHAR_UUID);
        await tx.startNotifications();
        tx.addEventListener('characteristicvaluechanged', handleNotify);
        const rx = await service.getCharacteristic(NUS_RX_CHAR_UUID);

        ble = { device, server, service, rx, tx, connected:true };
        setBleUI(true);
      } catch(err){
        console.error(err);
        ble.connected = false; setBleUI(false);
      }
    }

    function handleNotify(ev){
      const text = dec.decode(ev.target.value).trim();
      const value = parseIncomingValue(text);
      inFlight = false;
      clearTimeout(askTimer);

      if (pendingDot){
        pendingDot.classList.remove('gray');
        pendingDot.classList.add('blue');
        pendingDot.textContent = value;
        const idx = Number(pendingDot.dataset.index);
        const label = pendingDot.dataset.label;
        upsertReading(idx, label, value);
        pendingDot = null;
        btnSave.disabled = readings.length === 0;
      }
    }

    // Tolerant parser: first numeric token, else raw
    function parseIncomingValue(t){
      const m = t.match(/-?\d+(\.\d+)?/);
      return m ? m[0] : t;
    }

    async function sendRaw(str){
      if (!ble.connected || !ble.rx) return;
      try{ await ble.rx.writeValueWithoutResponse(enc.encode(str)); }
      catch(err){ console.error('BLE send error', err); }
    }

    async function requestReadingForDot(dotEl){
      if (!ble.connected){ alert('Connect to the BLE device first.'); return; }
      if (inFlight) return;
      pendingDot = dotEl;
      inFlight = true;
      await sendRaw('?');

      clearTimeout(askTimer);
      askTimer = setTimeout(() => {
        if (inFlight){
          inFlight = false;
          pendingDot = null;
          alert('No response from device within 2 seconds.');
        }
      }, 2000);
    }

    function upsertReading(index, label, value){
      const pos = readings.findIndex(r => r.index === index);
      if (pos >= 0) readings[pos] = { index, label, value };
      else readings.push({ index, label, value });
    }

    /********************  Save to Firestore (variances)  ********************/
    async function saveVariance(){
      if (!user){ alert('Sign in required.'); return; }
      if (!currentTemplate){ alert('Pick a template first.'); return; }
      if (readings.length === 0){ alert('Take at least one reading.'); return; }

      const payload = {
        templateId: currentTemplate.id,
        templateName: currentTemplate.name || currentTemplate.id,
        rinkName: selRink.value,
        padName: selPad.value,
        employeeName: selEmp.value,
        readings, // [{index,label,value}]
        createdAt: serverTimestamp()
      };
      try {
        const col = collection(db, 'users', user.uid, 'variances');
        await addDoc(col, payload);
        alert('Variance saved.');
      } catch (err){
        console.error(err);
        alert('Save failed. Check console.');
      }
    }

    /********************  Wire up UI  ********************/
    btnConnect.addEventListener('click', connectBle);
    btnSave.addEventListener('click', saveVariance);

    // Prevent ghost-drag of image
    document.addEventListener('dragstart', e => { if (e.target.tagName==='IMG') e.preventDefault(); }, {capture:true});
  </script>
</body>
</html>
